name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  APP_NAME: ${{ vars.APP_NAME }} # webgoat o juiceshop
  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_REPO }}:${{ github.sha }}
  INFRA_MANIFESTS_REPO: ${{ vars.INFRA_REPO }}
  DEFECTDOJO_API: ${{ secrets.DEFECTDOJO_API_URL }}
  DEFECTDOJO_TOKEN: ${{ secrets.DEFECTDOJO_API_TOKEN }}

jobs:
  ci:
    runs-on: [self-hosted, linux, x64, shared]

    steps:
    # 1. Checkout del repositorio de la app
    - name: Checkout application repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    # Instalar dependencias maven
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y maven
      shell: bash

    # 1.1 Checkout del repo de la aplicaci√≥n (WebGoat o JuiceShop)
    - name: Checkout application repo
      run: |
        git clone https://github.com/dberdasco99/webgoat-app.git app
      shell: bash

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '25'

    - name: Install Gitleaks
      run: |
        curl -L https://github.com/zricethezav/gitleaks/releases/download/v8.17.0/gitleaks_8.17.0_linux_x64.tar.gz -o gitleaks.tar.gz
        tar -xvf gitleaks.tar.gz
        chmod +x gitleaks
        sudo mv gitleaks /usr/local/bin/

    - name: Install Semgrep
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-venv python3-pip
        python3 -m pip install --upgrade pip
        pip install semgrep

    - name: Install OWASP Dependency-Check
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip
        curl -L -o dependency-check.zip https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.2/dependency-check-8.4.2-release.zip
        unzip dependency-check.zip -d dependency-check
        sudo ln -s $(pwd)/dependency-check/bin/dependency-check.sh /usr/local/bin/dependency-check.sh

    # 2. Preflight (Secret scanning, SAST, SCA)
    - name: Preflight / Gitleaks
      run: |
        mkdir -p reports
        bash preflight/run_gitleaks.sh
      env:
        APP_NAME: webgoat  # o juiceshop
    
    - name: Preflight / Semgrep
      run: |
        mkdir -p reports
        bash preflight/run_semgrep.sh
      env:
        APP_NAME: webgoat
    
    - name: Preflight / Dependency-Check
      run: |
        mkdir -p reports
        bash preflight/run_dependency_check.sh
      env:
        APP_NAME: webgoat


    # 3. Docker Build
    - name: Build Docker image
      env:
        DOCKER_IMAGE: dani359/webgoat:${{ github.sha }}
      run: |
        rm -rf app
        git clone https://github.com/dberdasco99/webgoat-app app
        cd app
        bash ../docker/build.sh


    # 4. Image Scanning (Trivy)
    - name: Install Trivy
      run: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
        
    - name: Scan Docker image
      env:
        DOCKER_IMAGE: dani359/webgoat:${{ github.sha }}
      run: bash docker/scan_image.sh

    # 5. Push Docker image
    - name: Push Docker image
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
        DOCKER_IMAGE: dani359/webgoat:${{ github.sha }}
      run: bash docker/push.sh


    # 6. Deploy (update manifests repo)
    - name: Update deployment manifests
      env:
        DOCKER_IMAGE: dani359/webgoat:${{ github.sha }}
        GITHUB_TOKEN_MANIFESTS: ${{ secrets.MANIFESTS_REPO_TOKEN }}
        APP_NAME: webgoat
      run: bash deploy/update_manifests.sh
      
    # 7. Push reports to DefectDojo
    - name: Upload scan reports
      env:
        APP_NAME: webgoat
        DEFECTDOJO_API: ${{ secrets.DEFECTDOJO_API_URL }}
        DEFECTDOJO_TOKEN: ${{ secrets.DEFECTDOJO_API_TOKEN }}
      run: bash defectdojo/upload_reports.sh

























